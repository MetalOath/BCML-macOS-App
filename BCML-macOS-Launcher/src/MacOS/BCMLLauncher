#!/bin/bash
# BCMLLauncher
# Description: macOS application launcher for BCML (BOTW Cross-Platform Mod Loader)
# Author: BCML Launcher Team
# Date: 2025-03-12

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CONFIG_PATH="${SCRIPT_DIR}/../Resources/config.json"

# Function to load configuration from JSON
load_config() {
  if [ -f "$CONFIG_PATH" ]; then
    # Try to use jq if available
    if command -v jq &> /dev/null; then
      BCML_PATH=$(jq -r '.bcml_path' "$CONFIG_PATH")
      VENV_ACTIVATE_PATH=$(jq -r '.venv_activate_path' "$CONFIG_PATH")
      # Load environment variables
      while IFS="=" read -r key value; do
        if [ -n "$key" ]; then
          export "$key"="$value"
        fi
      done < <(jq -r '.environment_variables | to_entries[] | "\(.key)=\(.value)"' "$CONFIG_PATH")
    else
      # Fallback to grep/sed if jq not available
      BCML_PATH=$(grep -o '"bcml_path": *"[^"]*"' "$CONFIG_PATH" | sed 's/"bcml_path": *"\([^"]*\)"/\1/')
      VENV_ACTIVATE_PATH=$(grep -o '"venv_activate_path": *"[^"]*"' "$CONFIG_PATH" | sed 's/"venv_activate_path": *"\([^"]*\)"/\1/')
      # Set known environment variables
      export QTWEBENGINE_DISABLE_SANDBOX=1
    fi
  else
    # Default values if config.json doesn't exist
    BCML_PATH="$(cd "$SCRIPT_DIR/../../../../" && pwd)/venv/bin/bcml"
    VENV_ACTIVATE_PATH="$(cd "$SCRIPT_DIR/../../../../" && pwd)/venv/bin/activate"
    export QTWEBENGINE_DISABLE_SANDBOX=1
  fi
}

# Function to display an error dialog
show_error() {
  osascript -e "display dialog \"$1\" buttons {\"OK\"} default button \"OK\" with title \"BCML Error\" with icon stop"
}

# Load configuration
load_config

# Check if BCML is installed
if [ -f "$BCML_PATH" ]; then
  # Activate the virtual environment and run BCML
  if [ -f "$VENV_ACTIVATE_PATH" ]; then
    source "$VENV_ACTIVATE_PATH"
    exec "$BCML_PATH"
  else
    show_error "Virtual environment activation script not found at '$VENV_ACTIVATE_PATH'.\n\nPlease check your installation."
    exit 1
  fi
else
  # Show error message if BCML is not found
  show_error "BCML not found at '$BCML_PATH'.\n\nPlease make sure you have installed BCML using the instructions in the repository."
  exit 1
fi
